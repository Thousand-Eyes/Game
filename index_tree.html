<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‹•æ…‹è³½å±€æ¨¹æ±‚è§£å™¨ V3.0 (Agentç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Noto Sans TC", sans-serif; overflow: hidden; }
        
        /* æ¨¹ç‹€çµæ§‹ä½ˆå±€æ ¸å¿ƒ */
        .tree { display: flex; justify-content: center; padding-top: 50px; padding-bottom: 100px; }
        .tree-node-container { display: flex; flex-direction: column; align-items: center; position: relative; padding: 0 20px; }
        .children-container { display: flex; flex-direction: row; justify-content: center; margin-top: 60px; }

        /* ç¯€é»æ¨£å¼ */
        .node-box {
            z-index: 10;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .node-decision {
            border: 3px solid #3b82f6;
            border-radius: 9999px; /* Pill/Circle */
            padding: 10px 20px;
            min-width: 100px;
            text-align: center;
        }
        .node-terminal {
            border: 3px solid #ef4444;
            border-radius: 12px;
            padding: 10px;
            min-width: 120px;
        }
        
        /* é«˜äº®æ¨£å¼ */
        .highlight-equilibrium {
            box-shadow: 0 0 25px rgba(34, 197, 94, 0.9);
            border-color: #22c55e !important;
            background-color: #f0fdf4;
            transform: scale(1.1);
            font-weight: bold;
        }

        /* è‡ªå‹•èª¿æ•´å¯¬åº¦çš„è¼¸å…¥æ¡†æ¨£å¼ */
        input.dynamic-width {
            background: rgba(255, 255, 255, 0.9);
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            outline: none;
            transition: all 0.2s;
            min-width: 60px;
            padding: 2px 8px;
            font-size: 12px;
            color: #475569;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        input.dynamic-width:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            z-index: 20;
        }

        input.editable-payoff {
            background: transparent;
            text-align: center;
            border: none;
            border-bottom: 1px dashed #94a3b8;
            outline: none;
            width: 100%;
            transition: border 0.2s;
        }
        input.editable-payoff:focus { border-bottom: 2px solid #3b82f6; }

        /* å ±é…¬è¼¸å…¥æ ¼æŸµ */
        .payoff-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 4px;
            align-items: center;
        }

        /* SVG é€£ç·šå±¤ */
        #svg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        path.connection {
            fill: none; stroke: #cbd5e1; stroke-width: 2; transition: all 0.5s ease;
        }
        
        path.equilibrium-path {
            stroke: #22c55e; 
            stroke-width: 6;
            stroke-dasharray: 20;
            animation: flow 1s linear infinite;
            z-index: 5;
        }

        path.off-path-optimal {
            stroke: #86efac; 
            stroke-width: 3;
            stroke-dasharray: 5, 5; 
        }

        @keyframes flow { to { stroke-dashoffset: -40; } }
        
        .canvas-area::-webkit-scrollbar { height: 10px; width: 10px; }
        .canvas-area::-webkit-scrollbar-track { background: #f1f5f9; }
        .canvas-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        .canvas-area::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal-overlay {
            background-color: rgba(0,0,0,0.5);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center; z-index: 50;
        }
        .modal-active { display: flex; }

        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex flex-col md:flex-row justify-between items-center shadow-sm z-20 relative">
        <div class="flex items-center gap-4 mb-2 md:mb-0">
            <div class="p-2 bg-gradient-to-br from-violet-600 to-fuchsia-600 rounded-lg text-white shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5c0-5.523 4.477-10 10-10z"/><path d="M8.5 8.5a2.5 2.5 0 0 0-2.5 2.5H5a4 5 0 0 0 0 9h6a4 5 0 0 0 0-9h-1a2.5 2.5 0 0 0-2.5-2.5z"/></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-900 leading-tight">AI å‹•æ…‹è³½å±€æ¨¹æ±‚è§£å™¨ <span class="text-violet-600 text-xs px-1 border border-violet-200 rounded">V3.0 Agent</span></h1>
                <p class="text-xs text-slate-500">AI è¼”åŠ©å»ºæ¨¡ | è‡ªå‹•åˆ†æ | å‡è¡¡æ±‚è§£</p>
            </div>
        </div>

        <div class="flex flex-wrap gap-2 justify-center">
            <!-- AI Agent Button (NEW) -->
            <button onclick="openAiModal()" class="px-4 py-1.5 text-sm font-bold text-white bg-violet-600 rounded-full shadow-lg hover:bg-violet-700 transition-all flex items-center gap-2 border border-violet-500 hover:scale-105">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                ğŸ¤– AI è‡ªå‹•ç”Ÿæˆ
            </button>

            <!-- Settings Button -->
            <button onclick="openSettings()" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                è¨­å®š
            </button>
            
            <button onclick="saveGame()" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                å„²å­˜
            </button>
            <label class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded hover:bg-slate-50 transition-colors flex items-center gap-1 cursor-pointer">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                åŒ¯å…¥
                <input type="file" id="fileInput" accept=".json" class="hidden" onchange="importGame(this)">
            </label>

            <!-- Actions -->
             <div class="h-6 w-px bg-slate-300 mx-1"></div>

            <button onclick="solveGame()" class="px-4 py-1.5 text-sm font-bold text-white bg-green-600 rounded shadow hover:bg-green-700 transition-colors flex items-center gap-1">
                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                è¨ˆç®—æœ€ä½³è§£
            </button>
        </div>
    </header>

    <!-- Main Canvas -->
    <main class="flex-1 relative overflow-hidden bg-slate-50 flex flex-col">
        <!-- Legend -->
        <div class="absolute top-4 left-4 z-20 bg-white/90 p-3 rounded-lg border border-slate-200 text-xs shadow-md backdrop-blur-sm pointer-events-none">
            <h3 class="font-bold mb-2 text-slate-600 border-b pb-1">åœ–ä¾‹èªªæ˜</h3>
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-1 bg-green-500 rounded"></div>
                <span>å‡è¡¡è·¯å¾‘ (Equilibrium Path)</span>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <div class="w-8 h-0 border-t-2 border-green-300 border-dashed"></div>
                <span>éå‡è¡¡çš„æœ€ä½³åæ‡‰</span>
            </div>
            <div class="text-[10px] text-slate-400 mt-1">
                æç¤ºï¼šé»æ“Šç¯€é»å¯ç·¨è¼¯ï¼Œå³ä¸Šè§’ AI å¯è‡ªå‹•ç”Ÿæˆ
            </div>
        </div>

        <!-- Canvas Container -->
        <div id="canvas-container" class="canvas-area w-full h-full overflow-auto relative cursor-grab active:cursor-grabbing" onmousedown="startDrag(event)">
            <svg id="svg-layer"></svg>
            <div id="tree-root" class="tree min-w-max min-h-max transform origin-top transition-transform duration-200">
                <!-- Tree Injected Here -->
            </div>
        </div>

        <!-- Zoom Controls -->
        <div class="absolute bottom-6 right-6 z-20 flex gap-2">
             <button onclick="zoom(-0.1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-bold">-</button>
             <button onclick="resetZoom()" class="px-3 h-8 bg-white rounded-full shadow border border-slate-200 hover:bg-slate-50 text-xs font-bold text-slate-600">100%</button>
             <button onclick="zoom(0.1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-full shadow border border-slate-200 hover:bg-slate-50 text-slate-600 font-bold">+</button>
        </div>
    </main>

    <!-- AI Agent Modal (NEW) -->
    <div id="ai-modal" class="modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-[500px] max-w-full m-4 border-t-4 border-violet-600">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    <span class="text-2xl">ğŸ¤–</span> AI è³½å±€åˆ†æå¸«
                </h2>
                <button onclick="closeAiModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="space-y-4">
                <!-- API Key Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Google Gemini API Key (å¿…å¡«)</label>
                    <input type="password" id="ai-api-key" placeholder="è²¼ä¸Šä½ çš„ API Key (AI Studio)" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-violet-500">
                    <p class="text-[10px] text-slate-400 mt-1">
                        æˆ‘å€‘ä¸æœƒå„²å­˜æ‚¨çš„ Keyï¼Œåƒ…ç”¨æ–¼æœ¬æ¬¡è«‹æ±‚ã€‚
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-violet-600 underline">å–å¾—å…è²» Key</a>
                    </p>
                </div>

                <!-- Model Selector -->
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">åˆ†ææ¨¡å‹</label>
                    <select id="ai-model-select" class="w-full px-3 py-2 border border-slate-300 rounded text-sm bg-white focus:outline-none focus:border-violet-500">
                        <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æœ€æ–°é è¦½)</option>
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash (å¿«é€Ÿç©©å®š)</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro (å¼·å¤§æ¨ç†)</option>
                    </select>
                </div>

                <!-- Prompt Input -->
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">è«‹æè¿°æ‚¨çš„è³½å±€æƒ…å¢ƒ</label>
                    <textarea id="ai-prompt" rows="5" placeholder="ä¾‹å¦‚ï¼š
æˆ‘æ˜¯ä¸€å€‹å·¥ç¨‹å¸«ï¼Œè€é—†è¦æ±‚æˆ‘åŠ ç­è¶•å°ˆæ¡ˆã€‚å¦‚æœæˆ‘æ‹’çµ•ï¼Œè€é—†å¯èƒ½æœƒç”Ÿæ°£æ‰£ç¸¾æ•ˆï¼Œæˆ–è€…ç„¡å¥ˆæ¥å—ã€‚å¦‚æœæˆ‘æ¥å—ï¼Œæˆ‘æœƒå¾ˆç´¯ä½†æœ‰åŠ ç­è²»...è«‹å¹«æˆ‘åˆ†æé€™å€‹å±€ã€‚" class="w-full px-3 py-2 border border-slate-300 rounded text-sm focus:outline-none focus:border-violet-500 resize-none"></textarea>
                </div>

                <!-- Action Button -->
                <button id="ai-generate-btn" onclick="generateGameFromAI()" class="w-full py-3 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition-colors flex justify-center items-center gap-2">
                    <span id="ai-btn-text">é–‹å§‹åˆ†æä¸¦ç”Ÿæˆ</span>
                    <div id="ai-spinner" class="loader hidden"></div>
                </button>
                
                <p id="ai-error-msg" class="text-xs text-red-500 text-center hidden"></p>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 max-w-full m-4">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></path></svg>
                è³½å±€ç©å®¶è¨­å®š
            </h2>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-slate-600 mb-2">ç©å®¶æ•¸é‡</label>
                <div class="flex items-center gap-3">
                    <button onclick="changePlayerCount(-1)" class="w-8 h-8 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold">-</button>
                    <span id="player-count-display" class="text-xl font-bold text-blue-600 w-8 text-center">2</span>
                    <button onclick="changePlayerCount(1)" class="w-8 h-8 rounded bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold">+</button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-bold text-slate-600 mb-2">ç©å®¶åç¨± (å°æ‡‰å ±é…¬é †åº)</label>
                <div id="player-names-list" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                    <!-- Dynamic Inputs -->
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t border-slate-100">
                <button onclick="closeSettings()" class="px-4 py-2 text-sm text-slate-500 hover:text-slate-700">å–æ¶ˆ</button>
                <button onclick="applySettings()" class="px-4 py-2 bg-blue-600 text-white text-sm font-bold rounded hover:bg-blue-700">å¥—ç”¨è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- Hidden Span for text measurement -->
    <span id="text-measurer" style="position:absolute; visibility:hidden; white-space:nowrap; font-size:12px; padding:2px 8px;"></span>

    <!-- JS Logic -->
    <script>
        // --- Configuration & State ---
        const CONFIG = {
            colors: ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'] 
        };

        let gameConfig = {
            playerCount: 2,
            playerNames: ["ç©å®¶ 1", "ç©å®¶ 2"]
        };

        class Node {
            constructor(id, parentId = null) {
                this.id = id;
                this.parentId = parentId;
                this.playerIdx = 0; 
                this.children = [];
                this.payoffs = Array(gameConfig.playerCount).fill(0);
                this.bestChildId = null; 
                this.description = ""; 
                this.isOnEquilibriumPath = false;
            }
        }

        let treeData = null;
        let scale = 1;
        let isDragging = false, startX, startY, scrollLeft, scrollTop;

        // --- Initialization ---
        function init() {
            treeData = new Node('root');
            treeData.playerIdx = 0; 
            addChild(treeData);
            addChild(treeData);
            renderTree();
        }

        // --- AI Agent Logic (NEW) ---
        function openAiModal() {
            document.getElementById('ai-modal').classList.add('modal-active');
            // Try to load key from local storage for convenience (optional)
            const savedKey = localStorage.getItem('gemini_api_key');
            if(savedKey) document.getElementById('ai-api-key').value = savedKey;
        }

        function closeAiModal() {
            document.getElementById('ai-modal').classList.remove('modal-active');
            document.getElementById('ai-error-msg').classList.add('hidden');
        }

        async function generateGameFromAI() {
            const apiKey = document.getElementById('ai-api-key').value.trim();
            const promptText = document.getElementById('ai-prompt').value.trim();
            const model = document.getElementById('ai-model-select').value;
            const btnText = document.getElementById('ai-btn-text');
            const spinner = document.getElementById('ai-spinner');
            const errorMsg = document.getElementById('ai-error-msg');

            if (!apiKey) {
                errorMsg.textContent = "è«‹è¼¸å…¥ Google Gemini API Key";
                errorMsg.classList.remove('hidden');
                return;
            }
            if (!promptText) {
                errorMsg.textContent = "è«‹è¼¸å…¥è³½å±€æƒ…å¢ƒæè¿°";
                errorMsg.classList.remove('hidden');
                return;
            }

            // Save key for convenience
            localStorage.setItem('gemini_api_key', apiKey);

            // UI Loading State
            btnText.textContent = "AI åˆ†æä¸­...";
            spinner.classList.remove('hidden');
            errorMsg.classList.add('hidden');
            document.getElementById('ai-generate-btn').disabled = true;

            const systemPrompt = `
                You are a Game Theory Expert. Analyze the user's scenario and output a valid JSON representing the game tree.
                
                RULES:
                1. Output ONLY valid JSON. No markdown formatting (no \`\`\`json).
                2. Structure must match this schema:
                   {
                     "config": { "playerCount": number, "playerNames": ["name1", "name2"] },
                     "tree": {
                       "id": "root",
                       "parentId": null,
                       "playerIdx": 0,
                       "description": "Root Context",
                       "payoffs": [0, 0],
                       "children": [ ...recursive nodes... ]
                     }
                   }
                3. "playerIdx" is 0 for first player, 1 for second, etc.
                4. "payoffs" must be an array of numbers. Estimate logical payoffs based on the scenario (e.g., win=100, lose=-100).
                5. Create at least 2-3 levels of depth to show dynamics.
                6. Node IDs should be unique strings (e.g., "n1", "n2").
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: systemPrompt + "\n\nUser Scenario:\n" + promptText }]
                        }]
                    })
                });

                if (!response.ok) {
                    let errorText = response.statusText;
                    try {
                        const errorData = await response.json();
                        if (errorData.error && errorData.error.message) {
                            errorText = errorData.error.message;
                        }
                    } catch (e) { /* ignore json parse error */ }
                    throw new Error(`API è«‹æ±‚å¤±æ•— (${response.status}): ${errorText}`);
                }

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;
                
                // Clean markdown if present
                const cleanJson = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                const gameData = JSON.parse(cleanJson);

                if (!gameData.tree || !gameData.config) throw new Error("AI ç”Ÿæˆçš„è³‡æ–™æ ¼å¼éŒ¯èª¤");

                // Load Data
                gameConfig = gameData.config;
                treeData = restoreNodePrototype(gameData.tree);
                
                // Solve & Render
                solveGame();
                closeAiModal();
                alert("AI è³½å±€ç”ŸæˆæˆåŠŸï¼å·²è‡ªå‹•è¨ˆç®—æœ€ä½³è§£ã€‚");

            } catch (err) {
                console.error(err);
                errorMsg.textContent = "ç”Ÿæˆå¤±æ•—: " + err.message + " (è«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯)";
                errorMsg.classList.remove('hidden');
            } finally {
                // Reset UI
                btnText.textContent = "é–‹å§‹åˆ†æä¸¦ç”Ÿæˆ";
                spinner.classList.add('hidden');
                document.getElementById('ai-generate-btn').disabled = false;
            }
        }

        // --- Save / Load Logic ---

        function saveGame() {
            const data = {
                version: "3.0",
                timestamp: new Date().toISOString(),
                config: gameConfig,
                tree: treeData
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `gametree_ai_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importGame(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.tree || !data.config) throw new Error("ç„¡æ•ˆçš„æª”æ¡ˆæ ¼å¼");
                    
                    gameConfig = data.config;
                    treeData = restoreNodePrototype(data.tree);
                    
                    solveGame(); // Auto solve on load
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                } catch (err) {
                    alert("åŒ¯å…¥å¤±æ•—: " + err.message);
                }
                input.value = ''; 
            };
            reader.readAsText(file);
        }

        function restoreNodePrototype(node) {
            node.isOnEquilibriumPath = false; 
            if (node.children) {
                node.children.forEach(restoreNodePrototype);
            }
            // Ensure payoff length matches config
            if (node.payoffs.length !== gameConfig.playerCount) {
                const newPay = Array(gameConfig.playerCount).fill(0);
                node.payoffs.forEach((p, i) => { if(i < newPay.length) newPay[i] = p; });
                node.payoffs = newPay;
            }
            return node;
        }


        // --- Settings Logic ---
        
        let tempConfig = {}; 

        function openSettings() {
            tempConfig = JSON.parse(JSON.stringify(gameConfig)); 
            document.getElementById('player-count-display').innerText = tempConfig.playerCount;
            renderSettingsInputs();
            document.getElementById('settings-modal').classList.add('modal-active');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('modal-active');
        }

        function changePlayerCount(delta) {
            let newCount = tempConfig.playerCount + delta;
            if (newCount < 1) newCount = 1;
            if (newCount > 6) newCount = 6;
            
            tempConfig.playerCount = newCount;
            document.getElementById('player-count-display').innerText = newCount;
            
            if (tempConfig.playerNames.length < newCount) {
                for (let i = tempConfig.playerNames.length; i < newCount; i++) {
                    tempConfig.playerNames.push(`ç©å®¶ ${i + 1}`);
                }
            } else if (tempConfig.playerNames.length > newCount) {
                tempConfig.playerNames = tempConfig.playerNames.slice(0, newCount);
            }
            
            renderSettingsInputs();
        }

        function renderSettingsInputs() {
            const container = document.getElementById('player-names-list');
            container.innerHTML = '';
            tempConfig.playerNames.forEach((name, idx) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2";
                
                const colorDot = document.createElement('div');
                colorDot.className = "w-4 h-4 rounded-full";
                colorDot.style.backgroundColor = CONFIG.colors[idx % CONFIG.colors.length];
                
                const input = document.createElement('input');
                input.value = name;
                input.className = "flex-1 border border-slate-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none";
                input.oninput = (e) => { tempConfig.playerNames[idx] = e.target.value; };
                
                div.appendChild(colorDot);
                div.appendChild(input);
                container.appendChild(div);
            });
        }

        function applySettings() {
            gameConfig = JSON.parse(JSON.stringify(tempConfig));
            updateTreePayoffs(treeData);
            closeSettings();
            renderTree(); 
        }

        function updateTreePayoffs(node) {
            const currentLen = node.payoffs.length;
            const targetLen = gameConfig.playerCount;
            if (currentLen < targetLen) {
                for (let i = 0; i < targetLen - currentLen; i++) node.payoffs.push(0);
            } else if (currentLen > targetLen) {
                node.payoffs = node.payoffs.slice(0, targetLen);
            }
            if (node.playerIdx >= targetLen) node.playerIdx = 0;
            node.children.forEach(updateTreePayoffs);
        }


        // --- Tree Management ---

        function addChild(parentNode) {
            const id = 'n-' + Math.random().toString(36).substr(2, 9);
            const newNode = new Node(id, parentNode.id);
            newNode.description = `é¸é … ${parentNode.children.length + 1}`;
            newNode.playerIdx = (parentNode.playerIdx + 1) % gameConfig.playerCount;
            parentNode.children.push(newNode);
            renderTree();
        }

        function removeNode(nodeId, parentId) {
            if (!parentId) return;
            const parent = findNode(treeData, parentId);
            if (parent) {
                parent.children = parent.children.filter(c => c.id !== nodeId);
                renderTree();
            }
        }

        function findNode(node, id) {
            if (node.id === id) return node;
            for (let child of node.children) {
                const found = findNode(child, id);
                if (found) return found;
            }
            return null;
        }

        function updateNodeData(id, type, value, index = 0) {
            const node = findNode(treeData, id);
            if (!node) return;

            if (type === 'desc') node.description = value;
            if (type === 'playerIdx') node.playerIdx = parseInt(value);
            if (type === 'payoff') {
                node.payoffs[index] = parseFloat(value) || 0;
            }

            if (type !== 'desc') {
                clearSolution(treeData);
                renderTree();
            }
        }

        // --- Logic: Backward Induction with Path Tracing ---

        function solveGame() {
            clearSolution(treeData);
            backwardInduction(treeData);
            traceEquilibriumPath(treeData);
            renderTree();
        }

        function clearSolution(node) {
            node.bestChildId = null;
            node.isOnEquilibriumPath = false;
            node.children.forEach(clearSolution);
        }

        function backwardInduction(node) {
            if (node.children.length === 0) return [...node.payoffs];

            let bestVal = -Infinity;
            let bestPayoffs = null;
            let bestChildId = null;
            const currentPlayerIdx = node.playerIdx;

            for (let child of node.children) {
                const childResult = backwardInduction(child);
                const val = childResult[currentPlayerIdx];

                if (val > bestVal) {
                    bestVal = val;
                    bestPayoffs = childResult;
                    bestChildId = child.id;
                } else if (val === bestVal && bestPayoffs === null) {
                    bestPayoffs = childResult;
                    bestChildId = child.id;
                }
            }

            node.bestChildId = bestChildId;
            return bestPayoffs;
        }

        function traceEquilibriumPath(node) {
            node.isOnEquilibriumPath = true;
            if (node.bestChildId) {
                const bestChild = node.children.find(c => c.id === node.bestChildId);
                if (bestChild) {
                    traceEquilibriumPath(bestChild);
                }
            }
        }

        // --- Auto-Resize Logic ---
        function adjustWidth(input) {
            const measurer = document.getElementById('text-measurer');
            if(!measurer) return;
            measurer.textContent = input.value || input.placeholder;
            const width = measurer.offsetWidth;
            input.style.width = Math.max(60, width + 15) + 'px';
        }

        // --- Rendering ---

        function renderTree() {
            const rootContainer = document.getElementById('tree-root');
            rootContainer.innerHTML = '';
            rootContainer.appendChild(buildNodeDOM(treeData));
            requestAnimationFrame(drawConnections);
        }

        function buildNodeDOM(node) {
            const container = document.createElement('div');
            container.className = 'tree-node-container';
            container.id = `node-container-${node.id}`;

            const nodeBox = document.createElement('div');
            const isLeaf = node.children.length === 0;
            const isRoot = !node.parentId;

            let cssClass = 'node-box ';
            cssClass += isLeaf ? 'node-terminal ' : 'node-decision ';
            
            if (node.isOnEquilibriumPath) {
                cssClass += ' highlight-equilibrium';
            }
            
            nodeBox.className = cssClass;
            nodeBox.id = `node-visual-${node.id}`;

            // Content
            if (!isLeaf) {
                const playerColor = CONFIG.colors[node.playerIdx % CONFIG.colors.length];
                let optionsHtml = '';
                gameConfig.playerNames.forEach((name, idx) => {
                    optionsHtml += `<option value="${idx}" ${node.playerIdx === idx ? 'selected' : ''}>${name}</option>`;
                });

                nodeBox.style.borderColor = playerColor;
                nodeBox.innerHTML = `
                    <div class="mb-1">
                        <select onchange="updateNodeData('${node.id}', 'playerIdx', this.value)" 
                            class="bg-transparent font-bold text-sm text-center outline-none cursor-pointer" 
                            style="color: ${playerColor}">
                            ${optionsHtml}
                        </select>
                    </div>
                    <div class="flex justify-center mt-2 gap-1 border-t pt-1 border-slate-100">
                        <button onclick="addChildWrapper('${node.id}')" class="text-xs bg-slate-100 hover:bg-blue-100 text-blue-600 rounded px-2 py-0.5" title="æ–°å¢åˆ†æ”¯">+</button>
                        ${!isRoot ? `<button onclick="removeNode('${node.id}', '${node.parentId}')" class="text-xs bg-slate-100 hover:bg-red-100 text-red-600 rounded px-2 py-0.5" title="åˆªé™¤ç¯€é»">Ã—</button>` : ''}
                    </div>
                `;
            } else {
                let payoffsHtml = '';
                gameConfig.playerNames.forEach((name, idx) => {
                    const color = CONFIG.colors[idx % CONFIG.colors.length];
                    payoffsHtml += `
                        <div class="text-xs font-bold text-right truncate" style="color:${color}">${name[0]}:</div>
                        <input type="number" value="${node.payoffs[idx]}" 
                             class="editable-payoff text-sm" 
                             style="color:${color}"
                             onchange="updateNodeData('${node.id}', 'payoff', this.value, ${idx})">
                    `;
                });

                nodeBox.innerHTML = `
                    <div class="payoff-grid">
                        ${payoffsHtml}
                    </div>
                    <div class="flex justify-between mt-2 pt-1 border-t border-slate-100">
                         <button onclick="addChildWrapper('${node.id}')" class="text-[10px] text-blue-500 hover:underline">æ“´å±•</button>
                         <button onclick="removeNode('${node.id}', '${node.parentId}')" class="text-[10px] text-red-500 hover:underline">åˆªé™¤</button>
                    </div>
                `;
            }

            // Branch Label with Auto-Resize
            if (node.parentId) {
                const label = document.createElement('input');
                label.value = node.description;
                label.className = "absolute -top-8 dynamic-width transform -translate-y-1"; 
                // Initial Width Calc
                setTimeout(() => adjustWidth(label), 0);
                
                label.oninput = (e) => {
                    adjustWidth(e.target);
                    updateNodeData(node.id, 'desc', e.target.value);
                };
                container.appendChild(label);
            }

            container.appendChild(nodeBox);

            if (node.children.length > 0) {
                const childrenCont = document.createElement('div');
                childrenCont.className = 'children-container';
                node.children.forEach(child => childrenCont.appendChild(buildNodeDOM(child)));
                container.appendChild(childrenCont);
            }

            return container;
        }

        function addChildWrapper(id) {
            const node = findNode(treeData, id);
            addChild(node);
        }

        // --- Drawing Lines ---

        function drawConnections() {
            const svg = document.getElementById('svg-layer');
            svg.innerHTML = ''; 

            const getCoords = (elemId) => {
                const elem = document.getElementById(elemId);
                const container = document.getElementById('canvas-container');
                if (!elem || !container) return null;
                const rect = elem.getBoundingClientRect();
                const contRect = container.getBoundingClientRect();
                return {
                    x: rect.left - contRect.left + container.scrollLeft + rect.width / 2,
                    y: rect.top - contRect.top + container.scrollTop + rect.height / 2,
                    bottom: rect.bottom - contRect.top + container.scrollTop,
                    top: rect.top - contRect.top + container.scrollTop
                };
            };

            const drawLine = (node) => {
                if (node.children.length > 0) {
                    const parentCoords = getCoords(`node-visual-${node.id}`);
                    if (!parentCoords) return;

                    node.children.forEach(child => {
                        const childCoords = getCoords(`node-visual-${child.id}`);
                        if (!childCoords) return;

                        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                        const startX = parentCoords.x;
                        const startY = parentCoords.bottom;
                        const endX = childCoords.x;
                        const endY = childCoords.top;
                        
                        const cp1y = startY + (endY - startY) / 2;
                        const cp2y = endY - (endY - startY) / 2;
                        const d = `M ${startX} ${startY} C ${startX} ${cp1y}, ${endX} ${cp2y}, ${endX} ${endY}`;
                        
                        path.setAttribute("d", d);
                        
                        let className = "connection";
                        const isOptimalMove = (node.bestChildId === child.id);
                        
                        if (isOptimalMove) {
                            if (node.isOnEquilibriumPath) {
                                className += " equilibrium-path";
                            } else {
                                className += " off-path-optimal";
                            }
                        }
                        
                        path.setAttribute("class", className);
                        svg.appendChild(path);

                        drawLine(child);
                    });
                }
            };

            const rootEl = document.getElementById('tree-root');
            svg.style.width = Math.max(rootEl.scrollWidth + 100, window.innerWidth) + 'px';
            svg.style.height = Math.max(rootEl.scrollHeight + 100, window.innerHeight) + 'px';

            drawLine(treeData);
        }

        function zoom(delta) {
            scale = Math.max(0.4, Math.min(2, scale + delta));
            document.getElementById('tree-root').style.transform = `scale(${scale})`;
            drawConnections();
        }
        function resetZoom() {
            scale = 1;
            document.getElementById('tree-root').style.transform = `scale(1)`;
            drawConnections();
        }

        const slider = document.getElementById('canvas-container');
        function startDrag(e) {
            if(['INPUT','BUTTON','SELECT'].includes(e.target.tagName)) return;
            isDragging = true;
            startX = e.pageX - slider.offsetLeft;
            startY = e.pageY - slider.offsetTop;
            scrollLeft = slider.scrollLeft;
            scrollTop = slider.scrollTop;
        }
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const y = e.pageY - slider.offsetTop;
            slider.scrollLeft = scrollLeft - (x - startX);
            slider.scrollTop = scrollTop - (y - startY);
        });
        window.addEventListener('resize', drawConnections);

        init();
    </script>
</body>
</html>